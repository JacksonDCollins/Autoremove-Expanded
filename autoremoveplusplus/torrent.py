''' dict_keys(['active_time', 'seeding_time', 'finished_time', 'all_time_download', 'storage_mode', 'distributed_copies', 'download_payload_rate', 'file_priorities',
'hash', 'auto_managed', 'is_auto_managed', 'is_finished', 'max_connections', 'max_download_speed', 'max_upload_slots', 'max_upload_speed', 'message', 'move_on_completed_path', 
'move_on_completed', 'move_completed_path', 'move_completed', 'next_announce', 'num_peers', 'num_seeds', 'owner', 'paused', 'prioritize_first_last', 'prioritize_first_last_pieces',
'sequential_download', 'progress', 'shared', 'remove_at_ratio', 'save_path', 'download_location', 'seeds_peers_ratio', 'seed_rank', 'state', 'stop_at_ratio', 'stop_ratio', 'time_added',
'total_done', 'total_payload_download', 'total_payload_upload', 'total_peers', 'total_seeds', 'total_uploaded', 'total_wanted', 'total_remaining', 'tracker', 'tracker_host', 'trackers',
'tracker_status', 'upload_payload_rate', 'comment', 'creator', 'num_files', 'num_pieces', 'piece_length', 'private', 'total_size', 'eta', 'file_progress', 'files', 'orig_files', 'is_seed',
'peers', 'queue', 'ratio', 'completed_time', 'last_seen_complete', 'name', 'pieces', 'seed_mode', 'super_seeding', 'time_since_download', 'time_since_upload', 'time_since_transfer'])'''

'''
23:25:36.559 [INFO    ][deluge                           :56  ] availability: 0.0
23:25:36.562 [INFO    ][deluge                           :56  ] active_time: 229441
23:25:36.567 [INFO    ][deluge                           :56  ] seeding_time: 0
23:25:36.569 [INFO    ][deluge                           :56  ] finished_time: 0
23:25:36.572 [INFO    ][deluge                           :56  ] all_time_download: 0.0
23:25:36.574 [INFO    ][deluge                           :56  ] is_finished: False
23:25:36.575 [INFO    ][deluge                           :56  ] num_peers: 0
23:25:36.577 [INFO    ][deluge                           :56  ] num_seeds: 0
23:25:36.579 [INFO    ][deluge                           :56  ] paused: False
23:25:36.580 [INFO    ][deluge                           :56  ] progress: 0.0
23:25:36.582 [INFO    ][deluge                           :56  ] shared: False
23:25:36.583 [INFO    ][deluge                           :56  ] seeds_peers_ratio: 0.0
23:25:36.585 [INFO    ][deluge                           :56  ] state: Downloading
23:25:36.586 [INFO    ][deluge                           :56  ] time_added: 1614676884
23:25:36.588 [INFO    ][deluge                           :56  ] total_done: 0
23:25:36.589 [INFO    ][deluge                           :56  ] total_peers: 1
23:25:36.590 [INFO    ][deluge                           :56  ] total_seeds: 0
23:25:36.591 [INFO    ][deluge                           :56  ] total_uploaded: 0
23:25:36.592 [INFO    ][deluge                           :56  ] total_wanted: 2277563021
23:25:36.593 [INFO    ][deluge                           :56  ] total_remaining: 2277563021
23:25:36.594 [INFO    ][deluge                           :56  ] tracker: udp://tracker.openbittorrent.com:80/announce
23:25:36.595 [INFO    ][deluge                           :56  ] tracker_host: openbittorrent.com
23:25:36.595 [INFO    ][deluge                           :56  ] eta: 0
23:25:36.596 [INFO    ][deluge                           :56  ] ratio: -1.0
23:25:36.597 [INFO    ][deluge                           :56  ] last_seen_complete: 0
23:25:36.598 [INFO    ][deluge                           :56  ] time_since_download: -1
23:25:36.599 [INFO    ][deluge                           :56  ] time_since_upload: -1
23:25:36.600 [INFO    ][deluge                           :56  ] time_since_transfer: -1
23:25:36.602 [INFO    ][deluge                           :56  ] availability: 8.984999656677246
23:25:36.602 [INFO    ][deluge                           :56  ] active_time: 828
23:25:36.603 [INFO    ][deluge                           :56  ] seeding_time: 0
23:25:36.604 [INFO    ][deluge                           :56  ] finished_time: 0
23:25:36.605 [INFO    ][deluge                           :56  ] all_time_download: 8.984999656677246
23:25:36.606 [INFO    ][deluge                           :56  ] is_finished: False
23:25:36.606 [INFO    ][deluge                           :56  ] num_peers: 3
23:25:36.607 [INFO    ][deluge                           :56  ] num_seeds: 8
23:25:36.608 [INFO    ][deluge                           :56  ] paused: False
23:25:36.609 [INFO    ][deluge                           :56  ] progress: 5.437200143933296
23:25:36.610 [INFO    ][deluge                           :56  ] shared: False
23:25:36.611 [INFO    ][deluge                           :56  ] seeds_peers_ratio: 1.0
23:25:36.612 [INFO    ][deluge                           :56  ] state: Downloading
23:25:36.612 [INFO    ][deluge                           :56  ] time_added: 1614914605
23:25:36.613 [INFO    ][deluge                           :56  ] total_done: 593379328
23:25:36.614 [INFO    ][deluge                           :56  ] total_peers: -1
23:25:36.615 [INFO    ][deluge                           :56  ] total_seeds: -1
23:25:36.616 [INFO    ][deluge                           :56  ] total_uploaded: 118368772
23:25:36.617 [INFO    ][deluge                           :56  ] total_wanted: 10913180220
23:25:36.618 [INFO    ][deluge                           :56  ] total_remaining: 10319800892
23:25:36.619 [INFO    ][deluge                           :56  ] tracker:
23:25:36.620 [INFO    ][deluge                           :56  ] tracker_host: coppersurfer.tk
23:25:36.621 [INFO    ][deluge                           :56  ] eta: 5464
23:25:36.622 [INFO    ][deluge                           :56  ] ratio: 0.19948246663557515
23:25:36.623 [INFO    ][deluge                           :56  ] last_seen_complete: 1614950734
23:25:36.624 [INFO    ][deluge                           :56  ] time_since_download: 34967
23:25:36.625 [INFO    ][deluge                           :56  ] time_since_upload: 34962
23:25:36.626 [INFO    ][deluge                           :56  ] time_since_transfer: 34962'''


from deluge.log import LOG as log
import deluge.component as component
import time


from .data_structs import wanted_params



# print(callable(wanted_params.get("availability").modifier_func))

class torrent:
	def __init__(self, torrent):
		self.torrent = torrent
		self.id = torrent.torrent_id

	def update(self):
		return
		for param in wanted_params.keys():
			log.info("{}: {}: {}".format(self.get_stat(param, desc=True), param, self.get_stat(param)))

	def get_stat(self, stat, desc = False):
		data = wanted_params.get(stat)
		if desc:
			return data.desc
		return data.modifier_func(self.torrent.get_status([data.stat])[data.stat])

		# return wanted_params.get(stat)[0](self.status) if not desc else wanted_params.get(stat)[1]

	
	# def status(self, stat):
	# 	return self.torrent.get_status("", all_keys=True)
	

class torrentmanager:
	def __init__(self, manager):
		self.index = -1
		self.manager = manager
		self.managed_torrents = {}
		for newtorrent in list(self.manager.torrents.values()):
			self.managed_torrents[newtorrent.torrent_id] = torrent(newtorrent)

	def update(self):
		to_remove = []
		for torid in self.torrent_ids:
			if not torid in list(self.manager.torrents.keys()):
				to_remove.append(torid)
		else:
			log.info("no changes")

		for torid in to_remove:
			log.info("removed {}".format(torid))
			del self.managed_torrents[torid]

		for newtorrent in list(self.manager.torrents.values()):
			if not newtorrent.torrent_id in self.torrent_ids:
				self.managed_torrents[newtorrent.torrent_id] = torrent(newtorrent)
				log.info("added {}".format(newtorrent.torrent_id))

		for newtorrent in self.torrents:
			newtorrent.update()

	@property
	def torrents(self):
		return list(self.managed_torrents.values())

	@property
	def torrent_ids(self):
		return list(self.managed_torrents.keys())
	
	